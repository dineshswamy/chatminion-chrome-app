// Generated by CoffeeScript 1.6.1
(function() {
  var loadRelaters, notificationandTTS, sender, sender_message;

  window.base_url = "http://localhost:3000";

  window.user_to_send = null;

  window.message_to_send = null;

  window.relater_collection = null;

  sender = null;

  window.logged_in_user = null;

  sender_message = null;

  window.messages = null;

  window.transformed_message = null;

  window.popup_window_opened = false;

  window.is_custom_message = true;

  window.custom_message = "";

  window.messages_with_options = [];

  window.options_for_message = [];

  chrome.browserAction.onClicked.addListener(function(tab) {
    if (!window.popup_window_opened) {
      return chrome.windows.create({
        url: '../popup.html',
        type: "popup",
        width: 300,
        height: 600
      }, null);
    }
  });

  window.sendMessage = function() {
    var data;
    data = {
      "sender_id": window.user_to_send.id,
      "channel_id": window.user_to_send.channel_id
    };
    if (window.is_custom_message) {
      data["is_custom_message"] = true;
      data["custom_message"] = window.custom_message;
    } else {
      ({
        "message_id": window.message_to_send.id
      });
    }
    console.log("data sent");
    console.log(data);
    return $.post(base_url + "/calltheteam/sendmessage", data, null);
  };

  notificationandTTS = function(notification_title, notification_message) {
    var notification;
    notification = webkitNotifications.createNotification(null, notification_title, notification_message);
    return notification.show();
  };

  window.getTransformedMessage = function(sender_name, reciever_name, transform_pattern) {
    var message_transform_helper;
    message_transform_helper = new MessageTransformation();
    message_transform_helper.init(transform_pattern, sender_name, reciever_name);
    message_transform_helper.applyTransformation();
    window.transformed_message = message_transform_helper.getMessage();
    return openOptionsPopupwindow();
  };

  window.openOptionsPopupwindow = function() {
    return window.options_window_id = chrome.windows.create({
      url: '../options_popup.html',
      type: "popup",
      width: 300,
      height: 600,
      title: "Chat minion"
    }, null);
  };

  window.dissectRecievedMessage = function(recieved_message) {
    var payload;
    if (window.relater_collection !== null) {
      payload = JSON.parse(recieved_message.payload);
      sender = window.relater_collection.findWhere({
        "id": Number(payload.user_id)
      });
      window.user_to_send = sender;
      if (!payload.is_custom_message) {
        return window.messages.getMessageInfo(Number(payload.message_id), function(payload_message) {
          return window.messages.loadOptionsforMessage(Number(payload.message_id), function() {}, window.getTransformedMessage(sender.name, window.logged_in_user.name, payload_message.transform_pattern));
        });
      } else {
        return window.getTransformedMessage(sender.name, window.logged_in_user.name, null);
      }
    }
  };

  window.initialize_extension = function(call_back) {
    return chrome.storage.local.get(["registered", "registered_user"], function(result) {
      if (result.registered === void 0 || result.registered_user === void 0) {
        return window.logged_in_user = null;
      } else {
        window.logged_in_user = result.registered_user;
        loadRelaters(window.logged_in_user.id, call_back);
        return chrome.pushMessaging.onMessage.addListener(dissectRecievedMessage);
      }
    });
  };

  loadRelaters = function(user_id, call_back) {
    window.relater_collection = new RelaterCollection({
      "user_id": user_id
    });
    return window.relater_collection.fetch({
      success: function() {
        window.messages = new Messages();
        window.messages.init();
        if (call_back !== null && call_back !== void 0) {
          call_back();
        }
        return console.log("relaters retrieved");
      },
      error: function() {
        return console.log("relaters retrieval error");
      }
    });
  };

  window.addRelaterToCollection = function(relater, call_back) {
    window.relater_collection.add(relater);
    if (call_back !== null && call_back !== void 0) {
      return call_back(relater);
    }
  };

  initialize_extension();

}).call(this);
